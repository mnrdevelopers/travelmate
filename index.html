<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelMate - Trip Management</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Lottie Player -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --danger-color: #e63946;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
            color: #333;
        }
        
        .splash-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
        }
        
        .splash-content {
            text-align: center;
            color: white;
        }
        
        .splash-logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
        }
        
        .auth-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 450px;
        }
        
        .auth-header {
            background: var(--primary-color);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .auth-body {
            padding: 30px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-google {
            background-color: #fff;
            color: #757575;
            border: 1px solid #ddd;
        }
        
        .btn-google:hover {
            background-color: #f8f9fa;
            border-color: #ccc;
        }
        
        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .trip-card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
            border: none;
            overflow: hidden;
        }
        
        .trip-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .trip-card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
        }
        
        .progress {
            height: 8px;
            border-radius: 4px;
        }
        
        .member-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .tab-content {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .nav-tabs .nav-link.active {
            background-color: white;
            border-bottom-color: white;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .expense-item {
            border-left: 4px solid var(--primary-color);
            padding-left: 15px;
            margin-bottom: 15px;
        }
        
        .itinerary-card {
            border-left: 4px solid var(--success-color);
            margin-bottom: 15px;
        }
        
        .success-animation {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        .trip-code {
            font-family: monospace;
            background-color: #e9ecef;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .category-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
        }
        
        .category-fuel { background-color: #ffd166; color: #333; }
        .category-hotel { background-color: #06d6a0; color: white; }
        .category-food { background-color: #ef476f; color: white; }
        .category-activities { background-color: #118ab2; color: white; }
        .category-other { background-color: #073b4c; color: white; }
        
        .distance-info {
            background-color: #e8f4fd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .route-step {
            padding: 10px 15px;
            border-left: 3px solid var(--primary-color);
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .page {
            display: none;
        }
        
        .active-page {
            display: block;
        }
        
        .rupee-symbol {
            font-family: Arial, sans-serif;
        }
        
        .currency-input {
            position: relative;
        }
        
        .currency-input::before {
            content: "₹";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #495057;
        }
        
        .currency-input input {
            padding-left: 25px;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash-screen" class="page active-page">
        <div class="splash-container">
            <div class="splash-content">
                <div class="splash-logo">
                    <i class="fas fa-map-marked-alt"></i>
                </div>
                <h1>TravelMate</h1>
                <p>Plan your trips together</p>
                <div class="mt-4">
                    <lottie-player 
                        src="https://assets1.lottiefiles.com/packages/lf20_sk5h1kfn.json" 
                        background="transparent" 
                        speed="1" 
                        style="width: 200px; height: 200px; margin: 0 auto;" 
                        loop 
                        autoplay>
                    </lottie-player>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Authentication Screen -->
    <div id="auth-screen" class="page">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h2><i class="fas fa-map-marked-alt me-2"></i>TravelMate</h2>
                    <p class="mb-0">Plan your trips together</p>
                </div>
                <div class="auth-body">
                    <div id="auth-animation" class="text-center mb-4">
                        <lottie-player 
                            src="https://assets1.lottiefiles.com/packages/lf20_sk5h1kfn.json" 
                            background="transparent" 
                            speed="1" 
                            style="width: 200px; height: 200px; margin: 0 auto;" 
                            loop 
                            autoplay>
                        </lottie-player>
                    </div>
                    
                    <div class="d-grid mb-3">
                        <button class="btn btn-google" id="google-signin-btn">
                            <i class="fab fa-google me-2"></i>Sign in with Google
                        </button>
                    </div>
                    
                    <div class="text-center mb-3">
                        <span class="text-muted">Or</span>
                    </div>
                    
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="login-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="login-password" required>
                        </div>
                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-primary">Login</button>
                        </div>
                        <div class="text-center">
                            <a href="#" id="show-signup">Don't have an account? Sign up</a>
                        </div>
                        <div class="text-center mt-2">
                            <a href="#" id="forgot-password">Forgot password?</a>
                        </div>
                    </form>
                    
                    <form id="signup-form" class="d-none">
                        <div class="mb-3">
                            <label for="signup-name" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="signup-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="signup-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="signup-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="signup-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="signup-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="signup-confirm-password" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="signup-confirm-password" required>
                        </div>
                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-primary">Sign Up</button>
                        </div>
                        <div class="text-center">
                            <a href="#" id="show-login">Already have an account? Login</a>
                        </div>
                    </form>
                    
                    <form id="reset-password-form" class="d-none">
                        <div class="mb-3">
                            <label for="reset-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="reset-email" required>
                        </div>
                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-primary">Reset Password</button>
                        </div>
                        <div class="text-center">
                            <a href="#" id="back-to-login">Back to Login</a>
                        </div>
                    </form>
                    
                    <div id="auth-message" class="alert d-none mt-3"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="app" class="page">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light sticky-top">
            <div class="container">
                <a class="navbar-brand fw-bold" href="#">
                    <i class="fas fa-map-marked-alt me-2 text-primary"></i>TravelMate
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" id="nav-dashboard">
                                <i class="fas fa-home me-1"></i>Dashboard
                            </a>
                        </li>
                    </ul>
                    <div class="d-flex align-items-center">
                        <img id="user-avatar" class="user-avatar me-2" src="" alt="User Avatar">
                        <span class="me-3" id="user-name">User</span>
                        <button class="btn btn-outline-primary btn-sm" id="logout-btn">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Dashboard -->
        <div id="dashboard-screen" class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>My Trips</h2>
                <div>
                    <button class="btn btn-primary me-2" id="create-trip-btn">
                        <i class="fas fa-plus me-1"></i>New Trip
                    </button>
                    <button class="btn btn-outline-primary" id="join-trip-btn">
                        <i class="fas fa-user-plus me-1"></i>Join Trip
                    </button>
                </div>
            </div>
            
            <div id="trips-container" class="row">
                <!-- Trips will be loaded here -->
            </div>
            
            <div id="empty-trips" class="empty-state">
                <lottie-player 
                    src="https://assets2.lottiefiles.com/packages/lf20_vybwn7df.json" 
                    background="transparent" 
                    speed="1" 
                    style="width: 300px; height: 300px; margin: 0 auto;" 
                    loop 
                    autoplay>
                </lottie-player>
                <h4>No trips yet</h4>
                <p>Create your first trip or join an existing one to get started!</p>
                <button class="btn btn-primary mt-2" id="create-first-trip-btn">
                    <i class="fas fa-plus me-1"></i>Create Your First Trip
                </button>
            </div>
        </div>
        
        <!-- Create Trip Modal -->
        <div class="modal fade" id="createTripModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create New Trip</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="create-trip-form">
                            <div class="mb-3">
                                <label for="trip-name" class="form-label">Trip Name</label>
                                <input type="text" class="form-control" id="trip-name" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="start-location" class="form-label">Start Location</label>
                                    <input type="text" class="form-control" id="start-location" placeholder="City, Country" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="trip-destination" class="form-label">Destination</label>
                                    <input type="text" class="form-control" id="trip-destination" placeholder="City, Country" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="start-date" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="start-date" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="end-date" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="end-date" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="trip-budget" class="form-label">Total Budget</label>
                                <div class="currency-input">
                                    <input type="number" class="form-control" id="trip-budget" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="calculate-distance">
                                <label class="form-check-label" for="calculate-distance">
                                    Calculate travel distance and time
                                </label>
                            </div>
                            <div id="distance-results" class="distance-info d-none">
                                <h6><i class="fas fa-route me-2"></i>Travel Information</h6>
                                <div id="distance-details">
                                    <!-- Distance results will appear here -->
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="save-trip-btn">Create Trip</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Join Trip Modal -->
        <div class="modal fade" id="joinTripModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Join a Trip</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="trip-code" class="form-label">Trip Code</label>
                            <input type="text" class="form-control" id="trip-code" placeholder="Enter 6-8 character code">
                        </div>
                        <div id="join-trip-message" class="alert d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="join-trip-code-btn">Join Trip</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Share Trip Code Modal -->
        <div class="modal fade" id="shareTripModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Share Trip Code</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="success-animation">
                            <lottie-player 
                                src="https://assets10.lottiefiles.com/packages/lf20_ykqwfq2g.json" 
                                background="transparent" 
                                speed="1" 
                                style="width: 150px; height: 150px;" 
                                autoplay>
                            </lottie-player>
                        </div>
                        <h4 class="mb-3">Trip Created Successfully!</h4>
                        <p>Share this code with your travel companions:</p>
                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <span class="trip-code me-3" id="share-trip-code">ABC123</span>
                            <button class="btn btn-outline-primary btn-sm" id="copy-code-btn">
                                <i class="fas fa-copy me-1"></i>Copy
                            </button>
                        </div>
                        <div id="copy-success" class="alert alert-success d-none mt-3">
                            Code copied to clipboard!
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Done</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trip Details Screen -->
        <div id="trip-details-screen" class="container mt-4 d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <button class="btn btn-outline-secondary me-2" id="back-to-dashboard">
                        <i class="fas fa-arrow-left me-1"></i>Back
                    </button>
                    <h2 id="trip-details-name" class="d-inline-block ms-2">Trip Name</h2>
                </div>
                <span class="trip-code" id="trip-details-code">ABC123</span>
            </div>
            
            <ul class="nav nav-tabs" id="trip-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#overview">
                        <i class="fas fa-info-circle me-1"></i>Overview
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#expenses">
                        <i class="fas fa-rupee-sign me-1"></i>Expenses
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#itinerary">
                        <i class="fas fa-route me-1"></i>Itinerary
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#route">
                        <i class="fas fa-map me-1"></i>Route
                    </a>
                </li>
            </ul>
            
            <div class="tab-content" id="trip-tab-content">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview">
                    <div class="row">
                        <div class="col-md-8">
                            <h4>Trip Information</h4>
                            <div class="card mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-sm-6 mb-3">
                                            <strong><i class="fas fa-map-marker-alt me-2 text-primary"></i>Start Location:</strong>
                                            <span id="overview-start-location">-</span>
                                        </div>
                                        <div class="col-sm-6 mb-3">
                                            <strong><i class="fas fa-flag-checkered me-2 text-primary"></i>Destination:</strong>
                                            <span id="overview-destination">-</span>
                                        </div>
                                        <div class="col-sm-6 mb-3">
                                            <strong><i class="fas fa-calendar-alt me-2 text-primary"></i>Dates:</strong>
                                            <span id="overview-dates">-</span>
                                        </div>
                                        <div class="col-sm-6 mb-3">
                                            <strong><i class="fas fa-road me-2 text-primary"></i>Distance:</strong>
                                            <span id="overview-distance">-</span>
                                        </div>
                                        <div class="col-sm-6 mb-3">
                                            <strong><i class="fas fa-rupee-sign me-2 text-primary"></i>Total Budget:</strong>
                                            <span id="overview-budget">-</span>
                                        </div>
                                        <div class="col-sm-6 mb-3">
                                            <strong><i class="fas fa-wallet me-2 text-primary"></i>Remaining Budget:</strong>
                                            <span id="overview-remaining">-</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Budget Progress:</strong>
                                        <div class="progress mt-2">
                                            <div id="budget-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h4>Trip Members</h4>
                            <div class="card">
                                <div class="card-body">
                                    <div id="members-list">
                                        <!-- Members will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Expenses Tab -->
                <div class="tab-pane fade" id="expenses">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4>Expenses</h4>
                                <button class="btn btn-primary" id="add-expense-btn">
                                    <i class="fas fa-plus me-1"></i>Add Expense
                                </button>
                            </div>
                            
                            <div id="expenses-list">
                                <!-- Expenses will be loaded here -->
                            </div>
                            
                            <div id="empty-expenses" class="empty-state">
                                <lottie-player 
                                    src="https://assets10.lottiefiles.com/packages/lf20_6wutsrox.json" 
                                    background="transparent" 
                                    speed="1" 
                                    style="width: 200px; height: 200px; margin: 0 auto;" 
                                    loop 
                                    autoplay>
                                </lottie-player>
                                <h4>No expenses yet</h4>
                                <p>Start adding expenses to track your spending!</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h4>Budget Summary</h4>
                            <div class="card mb-4">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <strong>Total Budget:</strong>
                                        <span id="summary-total-budget" class="float-end">₹0</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Total Spent:</strong>
                                        <span id="summary-total-spent" class="float-end">₹0</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Remaining:</strong>
                                        <span id="summary-remaining" class="float-end">₹0</span>
                                    </div>
                                    <div class="progress mt-3">
                                        <div id="summary-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <h4>Spending by Category</h4>
                            <div class="card">
                                <div class="card-body">
                                    <canvas id="expense-chart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Itinerary Tab -->
                <div class="tab-pane fade" id="itinerary">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4>Itinerary</h4>
                        <button class="btn btn-primary" id="add-activity-btn">
                            <i class="fas fa-plus me-1"></i>Add Activity
                        </button>
                    </div>
                    
                    <div id="itinerary-days">
                        <!-- Itinerary will be loaded here -->
                    </div>
                    
                    <div id="empty-itinerary" class="empty-state">
                        <lottie-player 
                            src="https://assets7.lottiefiles.com/packages/lf20_0skurerf.json" 
                            background="transparent" 
                            speed="1" 
                            style="width: 250px; height: 250px; margin: 0 auto;" 
                            loop 
                            autoplay>
                        </lottie-player>
                        <h4>No activities planned yet</h4>
                        <p>Start adding activities to your itinerary!</p>
                    </div>
                </div>
                
                <!-- Route Tab -->
                <div class="tab-pane fade" id="route">
                    <h4>Travel Route</h4>
                    <div class="card mb-4">
                        <div class="card-body">
                            <div id="route-details">
                                <!-- Route details will be loaded here -->
                            </div>
                            <div id="empty-route" class="empty-state">
                                <lottie-player 
                                    src="https://assets1.lottiefiles.com/packages/lf20_ki7nbraa.json" 
                                    background="transparent" 
                                    speed="1" 
                                    style="width: 200px; height: 200px; margin: 0 auto;" 
                                    loop 
                                    autoplay>
                                </lottie-player>
                                <h4>No route information</h4>
                                <p>Calculate distance to see route details</p>
                                <button class="btn btn-primary mt-2" id="calculate-route-btn">
                                    <i class="fas fa-route me-1"></i>Calculate Route
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Expense Modal -->
        <div class="modal fade" id="addExpenseModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Expense</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="add-expense-form">
                            <div class="mb-3">
                                <label for="expense-description" class="form-label">Description</label>
                                <input type="text" class="form-control" id="expense-description" required>
                            </div>
                            <div class="mb-3">
                                <label for="expense-amount" class="form-label">Amount</label>
                                <div class="currency-input">
                                    <input type="number" class="form-control" id="expense-amount" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="expense-category" class="form-label">Category</label>
                                <select class="form-select" id="expense-category" required>
                                    <option value="fuel">Fuel</option>
                                    <option value="hotel">Hotel</option>
                                    <option value="food">Food</option>
                                    <option value="activities">Activities</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="expense-date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="expense-date" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="save-expense-btn">Add Expense</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Activity Modal -->
        <div class="modal fade" id="addActivityModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Activity</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="add-activity-form">
                            <div class="mb-3">
                                <label for="activity-day" class="form-label">Day</label>
                                <select class="form-select" id="activity-day" required>
                                    <!-- Days will be populated dynamically -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="activity-time" class="form-label">Time</label>
                                <input type="time" class="form-control" id="activity-time" required>
                            </div>
                            <div class="mb-3">
                                <label for="activity-place" class="form-label">Place</label>
                                <input type="text" class="form-control" id="activity-place" required>
                            </div>
                            <div class="mb-3">
                                <label for="activity-notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="activity-notes" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="save-activity-btn">Add Activity</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBovkc7ohfvTlZUiqDQrQLW2B6aXAE000k",
            authDomain: "travel-mate-5729f.firebaseapp.com",
            projectId: "travel-mate-5729f",
            storageBucket: "travel-mate-5729f.firebasestorage.app",
            messagingSenderId: "164820425577",
            appId: "1:164820425577:web:dd1a93c232555a59f3bbf8",
            measurementId: "G-GETZV3X0ER"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // App state
        let currentUser = null;
        let currentTrip = null;
        let userTrips = [];
        let expenseChart = null;
        
        // DOM Elements
        const splashScreen = document.getElementById('splash-screen');
        const authScreen = document.getElementById('auth-screen');
        const app = document.getElementById('app');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const resetPasswordForm = document.getElementById('reset-password-form');
        const authMessage = document.getElementById('auth-message');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const forgotPassword = document.getElementById('forgot-password');
        const backToLogin = document.getElementById('back-to-login');
        const logoutBtn = document.getElementById('logout-btn');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const tripsContainer = document.getElementById('trips-container');
        const emptyTrips = document.getElementById('empty-trips');
        const createTripBtn = document.getElementById('create-trip-btn');
        const joinTripBtn = document.getElementById('join-trip-btn');
        const createFirstTripBtn = document.getElementById('create-first-trip-btn');
        const createTripModal = new bootstrap.Modal(document.getElementById('createTripModal'));
        const joinTripModal = new bootstrap.Modal(document.getElementById('joinTripModal'));
        const shareTripModal = new bootstrap.Modal(document.getElementById('shareTripModal'));
        const saveTripBtn = document.getElementById('save-trip-btn');
        const joinTripCodeBtn = document.getElementById('join-trip-code-btn');
        const copyCodeBtn = document.getElementById('copy-code-btn');
        const shareTripCode = document.getElementById('share-trip-code');
        const copySuccess = document.getElementById('copy-success');
        const tripDetailsScreen = document.getElementById('trip-details-screen');
        const backToDashboard = document.getElementById('back-to-dashboard');
        const tripDetailsName = document.getElementById('trip-details-name');
        const tripDetailsCode = document.getElementById('trip-details-code');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const addExpenseModal = new bootstrap.Modal(document.getElementById('addExpenseModal'));
        const saveExpenseBtn = document.getElementById('save-expense-btn');
        const addActivityBtn = document.getElementById('add-activity-btn');
        const addActivityModal = new bootstrap.Modal(document.getElementById('addActivityModal'));
        const saveActivityBtn = document.getElementById('save-activity-btn');
        const calculateDistanceCheckbox = document.getElementById('calculate-distance');
        const distanceResults = document.getElementById('distance-results');
        const calculateRouteBtn = document.getElementById('calculate-route-btn');
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Show splash screen for 2 seconds
            setTimeout(() => {
                initAuth();
            }, 2000);
            
            setupEventListeners();
        });
        
        // Initialize authentication state listener
        function initAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    showApp();
                    loadUserData();
                    loadUserTrips();
                } else {
                    currentUser = null;
                    showAuth();
                }
            });
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Auth form events
            googleSigninBtn.addEventListener('click', handleGoogleSignIn);
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);
            resetPasswordForm.addEventListener('submit', handleResetPassword);
            showSignup.addEventListener('click', showSignupForm);
            showLogin.addEventListener('click', showLoginForm);
            forgotPassword.addEventListener('click', showResetPasswordForm);
            backToLogin.addEventListener('click', showLoginForm);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Trip management events
            createTripBtn.addEventListener('click', showCreateTripModal);
            createFirstTripBtn.addEventListener('click', showCreateTripModal);
            joinTripBtn.addEventListener('click', showJoinTripModal);
            saveTripBtn.addEventListener('click', handleCreateTrip);
            joinTripCodeBtn.addEventListener('click', handleJoinTrip);
            copyCodeBtn.addEventListener('click', copyTripCode);
            backToDashboard.addEventListener('click', showDashboard);
            
            // Expense and itinerary events
            addExpenseBtn.addEventListener('click', showAddExpenseModal);
            saveExpenseBtn.addEventListener('click', handleAddExpense);
            addActivityBtn.addEventListener('click', showAddActivityModal);
            saveActivityBtn.addEventListener('click', handleAddActivity);
            
            // Distance calculation events
            calculateDistanceCheckbox.addEventListener('change', handleDistanceCalculationToggle);
            calculateRouteBtn.addEventListener('click', calculateRoute);
        }
        
        // Page navigation functions
        function showSplash() {
            splashScreen.classList.add('active-page');
            authScreen.classList.remove('active-page');
            app.classList.remove('active-page');
        }
        
        function showAuth() {
            splashScreen.classList.remove('active-page');
            authScreen.classList.add('active-page');
            app.classList.remove('active-page');
        }
        
        function showApp() {
            splashScreen.classList.remove('active-page');
            authScreen.classList.remove('active-page');
            app.classList.add('active-page');
        }
        
        function showDashboard() {
            dashboardScreen.classList.remove('d-none');
            tripDetailsScreen.classList.add('d-none');
        }
        
        // Authentication handlers
        function handleGoogleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    // User signed in successfully
                    const user = result.user;
                    
                    // Check if user exists in Firestore, if not create a new document
                    return db.collection('users').doc(user.uid).set({
                        name: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                })
                .catch((error) => {
                    console.error('Error during Google sign-in:', error);
                    showAuthMessage(error.message, 'danger');
                });
        }
        
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            showAuthMessage('Logging in...', 'info');
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    showAuthMessage('Login successful!', 'success');
                })
                .catch(error => {
                    showAuthMessage(error.message, 'danger');
                });
        }
        
        function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            
            if (password !== confirmPassword) {
                showAuthMessage('Passwords do not match!', 'danger');
                return;
            }
            
            showAuthMessage('Creating account...', 'info');
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Store user name in Firestore
                    return db.collection('users').doc(userCredential.user.uid).set({
                        name: name,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    showAuthMessage('Account created successfully!', 'success');
                })
                .catch(error => {
                    showAuthMessage(error.message, 'danger');
                });
        }
        
        function handleResetPassword(e) {
            e.preventDefault();
            const email = document.getElementById('reset-email').value;
            
            showAuthMessage('Sending reset email...', 'info');
            
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    showAuthMessage('Password reset email sent!', 'success');
                })
                .catch(error => {
                    showAuthMessage(error.message, 'danger');
                });
        }
        
        function handleLogout() {
            auth.signOut();
        }
        
        // Auth UI helpers
        function showAuthMessage(message, type) {
            authMessage.textContent = message;
            authMessage.className = `alert alert-${type} mt-3`;
            authMessage.classList.remove('d-none');
        }
        
        function showLoginForm() {
            loginForm.classList.remove('d-none');
            signupForm.classList.add('d-none');
            resetPasswordForm.classList.add('d-none');
            authMessage.classList.add('d-none');
        }
        
        function showSignupForm() {
            loginForm.classList.add('d-none');
            signupForm.classList.remove('d-none');
            resetPasswordForm.classList.add('d-none');
            authMessage.classList.add('d-none');
        }
        
        function showResetPasswordForm() {
            loginForm.classList.add('d-none');
            signupForm.classList.add('d-none');
            resetPasswordForm.classList.remove('d-none');
            authMessage.classList.add('d-none');
        }
        
        // Load user data from Firestore
        function loadUserData() {
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        userName.textContent = userData.name;
                        
                        // Set user avatar (use Google photo if available, otherwise use default)
                        if (userData.photoURL) {
                            userAvatar.src = userData.photoURL;
                        } else if (currentUser.photoURL) {
                            userAvatar.src = currentUser.photoURL;
                        } else {
                            // Use a default avatar or initials
                            userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.name)}&background=4361ee&color=fff`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                });
        }
        
        // Trip management functions
        function loadUserTrips() {
            // Query Firestore for trips where current user is a member
            db.collection('trips')
                .where('members', 'array-contains', currentUser.uid)
                .get()
                .then(querySnapshot => {
                    userTrips = [];
                    querySnapshot.forEach(doc => {
                        const tripData = doc.data();
                        userTrips.push({
                            id: doc.id,
                            ...tripData
                        });
                    });
                    renderTrips();
                })
                .catch(error => {
                    console.error('Error loading trips:', error);
                    // For demo purposes, use mock data if Firestore fails
                    userTrips = getMockTrips();
                    renderTrips();
                });
        }
        
        function getMockTrips() {
            return [
                {
                    id: 'trip1',
                    name: 'Goa Vacation',
                    startLocation: 'Mumbai, India',
                    destination: 'Goa, India',
                    startDate: '2023-12-15',
                    endDate: '2023-12-25',
                    budget: 25000,
                    code: 'GOA123',
                    members: ['user1', 'user2'],
                    distance: '590 km',
                    duration: '10 hours'
                },
                {
                    id: 'trip2',
                    name: 'Himalayan Trek',
                    startLocation: 'Delhi, India',
                    destination: 'Manali, India',
                    startDate: '2024-05-10',
                    endDate: '2024-05-20',
                    budget: 15000,
                    code: 'HIM456',
                    members: ['user1', 'user3', 'user4'],
                    distance: '540 km',
                    duration: '12 hours'
                }
            ];
        }
        
        function renderTrips() {
            tripsContainer.innerHTML = '';
            
            if (userTrips.length === 0) {
                emptyTrips.classList.remove('d-none');
                return;
            }
            
            emptyTrips.classList.add('d-none');
            
            userTrips.forEach(trip => {
                const tripCard = document.createElement('div');
                tripCard.className = 'col-md-6 col-lg-4';
                tripCard.innerHTML = `
                    <div class="card trip-card" data-trip-id="${trip.id}">
                        <div class="trip-card-header">
                            <h5 class="card-title mb-0">${trip.name}</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <i class="fas fa-map-marker-alt me-2 text-primary"></i>${trip.startLocation} → ${trip.destination}
                            </p>
                            <p class="card-text">
                                <i class="fas fa-calendar-alt me-2 text-primary"></i>${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}
                            </p>
                            <p class="card-text">
                                <i class="fas fa-rupee-sign me-2 text-primary"></i>Budget: ₹${trip.budget.toLocaleString('en-IN')}
                            </p>
                            ${trip.distance ? `<p class="card-text">
                                <i class="fas fa-route me-2 text-primary"></i>${trip.distance} (${trip.duration})
                            </p>` : ''}
                            <div class="d-flex align-items-center mt-3">
                                <div class="me-auto">
                                    ${renderMemberAvatars(trip.members)}
                                </div>
                                <button class="btn btn-sm btn-outline-primary view-trip-btn">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                tripsContainer.appendChild(tripCard);
                
                // Add event listener to the view trip button
                tripCard.querySelector('.view-trip-btn').addEventListener('click', () => {
                    showTripDetails(trip);
                });
            });
        }
        
        function renderMemberAvatars(members) {
            let avatarsHtml = '';
            const maxAvatars = 4;
            
            for (let i = 0; i < Math.min(members.length, maxAvatars); i++) {
                avatarsHtml += `<div class="member-avatar d-inline-block">U${i+1}</div>`;
            }
            
            if (members.length > maxAvatars) {
                avatarsHtml += `<div class="member-avatar d-inline-block">+${members.length - maxAvatars}</div>`;
            }
            
            return avatarsHtml;
        }
        
        function showCreateTripModal() {
            createTripModal.show();
        }
        
        function handleDistanceCalculationToggle() {
            if (calculateDistanceCheckbox.checked) {
                const startLocation = document.getElementById('start-location').value;
                const destination = document.getElementById('trip-destination').value;
                
                if (startLocation && destination) {
                    calculateDistance(startLocation, destination);
                }
            } else {
                distanceResults.classList.add('d-none');
            }
        }
        
        function calculateDistance(start, destination) {
            // Show loading state
            document.getElementById('distance-details').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Calculating distance...
                </div>
            `;
            distanceResults.classList.remove('d-none');
            
            // Use OpenStreetMap Nominatim API for geocoding and distance calculation
            // This is a free alternative to Google Maps API
            Promise.all([
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(start)}`),
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destination)}`)
            ])
            .then(responses => Promise.all(responses.map(response => response.json())))
            .then(data => {
                const startData = data[0];
                const destData = data[1];
                
                if (startData.length === 0 || destData.length === 0) {
                    throw new Error('Could not find one or both locations');
                }
                
                const startLat = parseFloat(startData[0].lat);
                const startLon = parseFloat(startData[0].lon);
                const destLat = parseFloat(destData[0].lat);
                const destLon = parseFloat(destData[0].lon);
                
                // Calculate distance using Haversine formula
                const distance = calculateHaversineDistance(startLat, startLon, destLat, destLon);
                const duration = estimateTravelTime(distance);
                
                displayDistanceResults(distance, duration, start, destination);
            })
            .catch(error => {
                console.error('Error calculating distance:', error);
                document.getElementById('distance-details').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Could not calculate distance. Please check your locations and try again.
                    </div>
                `;
            });
        }
        
        function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return distance;
        }
        
        function estimateTravelTime(distance) {
            // Estimate travel time based on distance
            // Assuming average speed of 60 km/h for road travel
            const hours = distance / 60;
            const wholeHours = Math.floor(hours);
            const minutes = Math.round((hours - wholeHours) * 60);
            
            if (wholeHours === 0) {
                return `${minutes} mins`;
            } else if (minutes === 0) {
                return `${wholeHours} hours`;
            } else {
                return `${wholeHours} hours ${minutes} mins`;
            }
        }
        
        function displayDistanceResults(distance, duration, start, destination) {
            document.getElementById('distance-details').innerHTML = `
                <p><strong>From:</strong> ${start}</p>
                <p><strong>To:</strong> ${destination}</p>
                <p><strong>Distance:</strong> ${distance.toFixed(1)} km</p>
                <p><strong>Estimated Travel Time:</strong> ${duration}</p>
            `;
        }
        
        function handleCreateTrip() {
            const name = document.getElementById('trip-name').value;
            const startLocation = document.getElementById('start-location').value;
            const destination = document.getElementById('trip-destination').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const budget = parseFloat(document.getElementById('trip-budget').value);
            
            // Generate a random trip code
            const code = generateTripCode();
            
            // Prepare trip data
            const tripData = {
                name,
                startLocation,
                destination,
                startDate,
                endDate,
                budget,
                code,
                members: [currentUser.uid],
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                expenses: [],
                itinerary: []
            };
            
            // Add distance information if calculated
            if (calculateDistanceCheckbox.checked) {
                const distanceText = document.querySelector('#distance-details p:nth-child(3)').textContent.replace('Distance: ', '');
                const durationText = document.querySelector('#distance-details p:nth-child(4)').textContent.replace('Estimated Travel Time: ', '');
                
                tripData.distance = distanceText;
                tripData.duration = durationText;
            }
            
            // Save to Firestore
            db.collection('trips').add(tripData)
                .then(docRef => {
                    // Add the new trip to local state
                    const newTrip = {
                        id: docRef.id,
                        ...tripData
                    };
                    
                    userTrips.push(newTrip);
                    renderTrips();
                    
                    createTripModal.hide();
                    shareTripCode.textContent = code;
                    shareTripModal.show();
                    
                    // Reset form
                    document.getElementById('create-trip-form').reset();
                    distanceResults.classList.add('d-none');
                    calculateDistanceCheckbox.checked = false;
                })
                .catch(error => {
                    console.error('Error creating trip:', error);
                    alert('Error creating trip. Please try again.');
                });
        }
        
        function showJoinTripModal() {
            document.getElementById('join-trip-message').classList.add('d-none');
            joinTripModal.show();
        }
        
        function handleJoinTrip() {
            const code = document.getElementById('trip-code').value.toUpperCase();
            const messageEl = document.getElementById('join-trip-message');
            
            // Query Firestore for a trip with this code
            db.collection('trips')
                .where('code', '==', code)
                .get()
                .then(querySnapshot => {
                    if (!querySnapshot.empty) {
                        const doc = querySnapshot.docs[0];
                        const tripData = doc.data();
                        
                        // Check if user is already a member
                        if (tripData.members.includes(currentUser.uid)) {
                            messageEl.textContent = 'You are already a member of this trip.';
                            messageEl.className = 'alert alert-warning';
                            messageEl.classList.remove('d-none');
                            return;
                        }
                        
                        // Add user to members array
                        return db.collection('trips').doc(doc.id).update({
                            members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                        }).then(() => {
                            // Add trip to local state
                            const joinedTrip = {
                                id: doc.id,
                                ...tripData
                            };
                            
                            userTrips.push(joinedTrip);
                            renderTrips();
                            
                            messageEl.textContent = 'Successfully joined the trip!';
                            messageEl.className = 'alert alert-success';
                            messageEl.classList.remove('d-none');
                            
                            setTimeout(() => {
                                joinTripModal.hide();
                                showTripDetails(joinedTrip);
                            }, 1500);
                        });
                    } else {
                        messageEl.textContent = 'Trip not found. Please check the code and try again.';
                        messageEl.className = 'alert alert-danger';
                        messageEl.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error joining trip:', error);
                    messageEl.textContent = 'Error joining trip. Please try again.';
                    messageEl.className = 'alert alert-danger';
                    messageEl.classList.remove('d-none');
                });
        }
        
        function copyTripCode() {
            navigator.clipboard.writeText(shareTripCode.textContent)
                .then(() => {
                    copySuccess.classList.remove('d-none');
                    setTimeout(() => {
                        copySuccess.classList.add('d-none');
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                });
        }
        
        function showTripDetails(trip) {
            currentTrip = trip;
            
            tripDetailsName.textContent = trip.name;
            tripDetailsCode.textContent = trip.code;
            
            // Update overview tab
            document.getElementById('overview-start-location').textContent = trip.startLocation;
            document.getElementById('overview-destination').textContent = trip.destination;
            document.getElementById('overview-dates').textContent = `${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}`;
            document.getElementById('overview-budget').textContent = `₹${trip.budget.toLocaleString('en-IN')}`;
            
            if (trip.distance) {
                document.getElementById('overview-distance').textContent = `${trip.distance} (${trip.duration})`;
            } else {
                document.getElementById('overview-distance').textContent = 'Not calculated';
            }
            
            // Calculate and display remaining budget
            updateBudgetOverview(trip);
            
            // Update members list
            loadTripMembers(trip);
            
            // Load itinerary for this trip
            loadTripItinerary(trip);
            
            // Load route information
            loadRouteInformation(trip);
            
            // Load expenses
            loadTripExpenses(trip);
            
            dashboardScreen.classList.add('d-none');
            tripDetailsScreen.classList.remove('d-none');
        }
        
        function updateBudgetOverview(trip) {
            const totalSpent = trip.expenses ? trip.expenses.reduce((sum, expense) => sum + expense.amount, 0) : 0;
            const remaining = trip.budget - totalSpent;
            const spentPercentage = (totalSpent / trip.budget) * 100;
            
            document.getElementById('overview-remaining').textContent = `₹${remaining.toLocaleString('en-IN')}`;
            
            const progressBar = document.getElementById('budget-progress-bar');
            progressBar.style.width = `${spentPercentage}%`;
            progressBar.textContent = `${spentPercentage.toFixed(1)}%`;
        }
        
        function loadTripMembers(trip) {
            const membersList = document.getElementById('members-list');
            membersList.innerHTML = '';
            
            // Get user details for each member
            const memberPromises = trip.members.map(memberId => {
                return db.collection('users').doc(memberId).get()
                    .then(doc => {
                        if (doc.exists) {
                            return doc.data();
                        } else {
                            return { name: 'Unknown User', photoURL: null };
                        }
                    })
                    .catch(() => {
                        return { name: 'Unknown User', photoURL: null };
                    });
            });
            
            Promise.all(memberPromises)
                .then(members => {
                    members.forEach((member, index) => {
                        const memberEl = document.createElement('div');
                        memberEl.className = 'd-flex align-items-center mb-2';
                        
                        const avatarSrc = member.photoURL || 
                            `https://ui-avatars.com/api/?name=${encodeURIComponent(member.name)}&background=4361ee&color=fff`;
                        
                        memberEl.innerHTML = `
                            <img src="${avatarSrc}" class="user-avatar me-2" alt="${member.name}">
                            <span>${member.name}</span>
                            ${trip.members[index] === trip.createdBy ? '<span class="badge bg-primary ms-2">Creator</span>' : ''}
                        `;
                        membersList.appendChild(memberEl);
                    });
                })
                .catch(error => {
                    console.error('Error loading members:', error);
                    // Fallback to simple display
                    trip.members.forEach((memberId, index) => {
                        const memberEl = document.createElement('div');
                        memberEl.className = 'd-flex align-items-center mb-2';
                        memberEl.innerHTML = `
                            <div class="member-avatar me-2">U${index+1}</div>
                            <span>User ${index+1}</span>
                            ${memberId === trip.createdBy ? '<span class="badge bg-primary ms-2">Creator</span>' : ''}
                        `;
                        membersList.appendChild(memberEl);
                    });
                });
        }
        
        function loadTripExpenses(trip) {
            const expensesList = document.getElementById('expenses-list');
            const emptyExpenses = document.getElementById('empty-expenses');
            
            if (!trip.expenses || trip.expenses.length === 0) {
                expensesList.innerHTML = '';
                emptyExpenses.classList.remove('d-none');
                updateBudgetSummary(trip);
                return;
            }
            
            emptyExpenses.classList.add('d-none');
            expensesList.innerHTML = '';
            
            trip.expenses.forEach(expense => {
                const expenseEl = document.createElement('div');
                expenseEl.className = 'expense-item';
                expenseEl.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">${expense.description}</h6>
                            <span class="category-badge category-${expense.category}">${expense.category.charAt(0).toUpperCase() + expense.category.slice(1)}</span>
                            <small class="text-muted">${formatDate(expense.date)}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">₹${expense.amount.toLocaleString('en-IN')}</div>
                            <small class="text-muted">Added by User</small>
                        </div>
                    </div>
                `;
                expensesList.appendChild(expenseEl);
            });
            
            updateBudgetSummary(trip);
            renderExpenseChart(trip);
        }
        
        function updateBudgetSummary(trip) {
            const totalBudget = trip.budget;
            const totalSpent = trip.expenses ? trip.expenses.reduce((sum, expense) => sum + expense.amount, 0) : 0;
            const remaining = totalBudget - totalSpent;
            const spentPercentage = (totalSpent / totalBudget) * 100;
            
            document.getElementById('summary-total-budget').textContent = `₹${totalBudget.toLocaleString('en-IN')}`;
            document.getElementById('summary-total-spent').textContent = `₹${totalSpent.toLocaleString('en-IN')}`;
            document.getElementById('summary-remaining').textContent = `₹${remaining.toLocaleString('en-IN')}`;
            
            const progressBar = document.getElementById('summary-progress-bar');
            progressBar.style.width = `${spentPercentage}%`;
            progressBar.textContent = `${spentPercentage.toFixed(1)}%`;
        }
        
        function renderExpenseChart(trip) {
            const ctx = document.getElementById('expense-chart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (expenseChart) {
                expenseChart.destroy();
            }
            
            if (!trip.expenses || trip.expenses.length === 0) {
                return;
            }
            
            // Group expenses by category
            const categories = {
                fuel: 0,
                hotel: 0,
                food: 0,
                activities: 0,
                other: 0
            };
            
            trip.expenses.forEach(expense => {
                categories[expense.category] += expense.amount;
            });
            
            // Filter out categories with no expenses
            const labels = [];
            const data = [];
            const backgroundColors = [
                '#ffd166', // fuel
                '#06d6a0', // hotel
                '#ef476f', // food
                '#118ab2', // activities
                '#073b4c'  // other
            ];
            
            Object.keys(categories).forEach((category, index) => {
                if (categories[category] > 0) {
                    labels.push(category.charAt(0).toUpperCase() + category.slice(1));
                    data.push(categories[category]);
                }
            });
            
            expenseChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function loadTripItinerary(trip) {
            const itineraryDays = document.getElementById('itinerary-days');
            const emptyItinerary = document.getElementById('empty-itinerary');
            
            if (!trip.itinerary || trip.itinerary.length === 0) {
                itineraryDays.innerHTML = '';
                emptyItinerary.classList.remove('d-none');
                return;
            }
            
            emptyItinerary.classList.add('d-none');
            itineraryDays.innerHTML = '';
            
            // Group activities by day
            const activitiesByDay = {};
            trip.itinerary.forEach(activity => {
                if (!activitiesByDay[activity.day]) {
                    activitiesByDay[activity.day] = [];
                }
                activitiesByDay[activity.day].push(activity);
            });
            
            // Display activities by day
            Object.keys(activitiesByDay).forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'card mb-3';
                dayCard.innerHTML = `
                    <div class="card-header">
                        <h5 class="mb-0">Day ${day}</h5>
                    </div>
                    <div class="card-body">
                        ${activitiesByDay[day].map(activity => `
                            <div class="itinerary-card">
                                <div class="card-body">
                                    <div class="d-flex">
                                        <div class="me-3">
                                            <i class="fas fa-clock text-primary"></i>
                                            <span class="ms-1 fw-bold">${activity.time}</span>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="card-title mb-1">${activity.place}</h6>
                                            <p class="card-text mb-0">${activity.notes || ''}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                itineraryDays.appendChild(dayCard);
            });
        }
        
        function loadRouteInformation(trip) {
            const routeDetails = document.getElementById('route-details');
            const emptyRoute = document.getElementById('empty-route');
            
            if (trip.distance) {
                emptyRoute.classList.add('d-none');
                routeDetails.innerHTML = `
                    <h5>${trip.startLocation} → ${trip.destination}</h5>
                    <div class="distance-info mt-3">
                        <p><strong>Distance:</strong> ${trip.distance}</p>
                        <p><strong>Estimated Travel Time:</strong> ${trip.duration}</p>
                    </div>
                    <div class="mt-3">
                        <h6>Suggested Route:</h6>
                        <div class="route-step">
                            <i class="fas fa-car me-2 text-primary"></i>
                            <strong>Road Trip:</strong> ${trip.startLocation} to ${trip.destination}
                        </div>
                        <div class="route-step">
                            <i class="fas fa-map-signs me-2 text-primary"></i>
                            <strong>Navigation:</strong> Follow NH48 for the most direct route
                        </div>
                    </div>
                `;
            } else {
                routeDetails.innerHTML = '';
                emptyRoute.classList.remove('d-none');
            }
        }
        
        function calculateRoute() {
            if (!currentTrip) return;
            
            // Show loading state
            document.getElementById('route-details').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Calculating route...
                </div>
            `;
            
            // Use OpenStreetMap Nominatim API for geocoding
            Promise.all([
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(currentTrip.startLocation)}`),
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(currentTrip.destination)}`)
            ])
            .then(responses => Promise.all(responses.map(response => response.json())))
            .then(data => {
                const startData = data[0];
                const destData = data[1];
                
                if (startData.length === 0 || destData.length === 0) {
                    throw new Error('Could not find one or both locations');
                }
                
                const startLat = parseFloat(startData[0].lat);
                const startLon = parseFloat(startData[0].lon);
                const destLat = parseFloat(destData[0].lat);
                const destLon = parseFloat(destData[0].lon);
                
                // Calculate distance using Haversine formula
                const distance = calculateHaversineDistance(startLat, startLon, destLat, destLon);
                const duration = estimateTravelTime(distance);
                
                displayRouteResults(distance, duration);
            })
            .catch(error => {
                console.error('Error calculating route:', error);
                document.getElementById('route-details').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Could not calculate route. Please try again.
                    </div>
                `;
            });
        }
        
        function displayRouteResults(distance, duration) {
            const routeDetails = document.getElementById('route-details');
            const emptyRoute = document.getElementById('empty-route');
            
            emptyRoute.classList.add('d-none');
            routeDetails.innerHTML = `
                <h5>${currentTrip.startLocation} → ${currentTrip.destination}</h5>
                <div class="distance-info mt-3">
                    <p><strong>Distance:</strong> ${distance.toFixed(1)} km</p>
                    <p><strong>Estimated Travel Time:</strong> ${duration}</p>
                </div>
                <div class="mt-3">
                    <h6>Suggested Route:</h6>
                    <div class="route-step">
                        <i class="fas fa-car me-2 text-primary"></i>
                        <strong>Road Trip:</strong> ${currentTrip.startLocation} to ${currentTrip.destination}
                    </div>
                    <div class="route-step">
                        <i class="fas fa-map-signs me-2 text-primary"></i>
                        <strong>Navigation:</strong> Follow the main highway for the most direct route
                    </div>
                </div>
            `;
            
            // Update the trip with distance information
            db.collection('trips').doc(currentTrip.id).update({
                distance: `${distance.toFixed(1)} km`,
                duration: duration
            }).then(() => {
                // Update local state
                currentTrip.distance = `${distance.toFixed(1)} km`;
                currentTrip.duration = duration;
                
                // Update overview tab
                document.getElementById('overview-distance').textContent = `${currentTrip.distance} (${currentTrip.duration})`;
            });
        }
        
        function showAddExpenseModal() {
            // Set today's date as default
            document.getElementById('expense-date').valueAsDate = new Date();
            addExpenseModal.show();
        }
        
        function handleAddExpense() {
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const date = document.getElementById('expense-date').value;
            
            // Create expense object
            const expense = {
                description,
                amount,
                category,
                date,
                addedBy: currentUser.uid,
                addedAt: new Date().toISOString()
            };
            
            // Update the trip with the new expense
            db.collection('trips').doc(currentTrip.id).update({
                expenses: firebase.firestore.FieldValue.arrayUnion(expense)
            })
            .then(() => {
                // Reload expenses to show the new one
                const updatedTrip = { ...currentTrip };
                if (!updatedTrip.expenses) {
                    updatedTrip.expenses = [];
                }
                updatedTrip.expenses.push(expense);
                showTripDetails(updatedTrip);
                
                addExpenseModal.hide();
                
                // Reset form
                document.getElementById('add-expense-form').reset();
            })
            .catch(error => {
                console.error('Error adding expense:', error);
                alert('Error adding expense. Please try again.');
            });
        }
        
        function showAddActivityModal() {
            addActivityModal.show();
            
            // Populate the day dropdown
            const activityDaySelect = document.getElementById('activity-day');
            activityDaySelect.innerHTML = '';
            
            // Generate options for all days of the trip
            const startDate = new Date(currentTrip.startDate);
            const endDate = new Date(currentTrip.endDate);
            const currentDate = new Date(startDate);
            let dayCount = 1;
            
            while (currentDate <= endDate) {
                const option = document.createElement('option');
                option.value = dayCount;
                option.textContent = `Day ${dayCount} (${formatDate(currentDate.toISOString().split('T')[0])})`;
                activityDaySelect.appendChild(option);
                
                currentDate.setDate(currentDate.getDate() + 1);
                dayCount++;
            }
        }
        
        function handleAddActivity() {
            const day = parseInt(document.getElementById('activity-day').value);
            const time = document.getElementById('activity-time').value;
            const place = document.getElementById('activity-place').value;
            const notes = document.getElementById('activity-notes').value;
            
            // Create activity object
            const activity = {
                day,
                time,
                place,
                notes,
                addedBy: currentUser.uid,
                addedAt: new Date().toISOString()
            };
            
            // Update the trip with the new activity
            db.collection('trips').doc(currentTrip.id).update({
                itinerary: firebase.firestore.FieldValue.arrayUnion(activity)
            })
            .then(() => {
                // Reload itinerary to show the new activity
                const updatedTrip = { ...currentTrip };
                if (!updatedTrip.itinerary) {
                    updatedTrip.itinerary = [];
                }
                updatedTrip.itinerary.push(activity);
                showTripDetails(updatedTrip);
                
                addActivityModal.hide();
                
                // Reset form
                document.getElementById('add-activity-form').reset();
            })
            .catch(error => {
                console.error('Error adding activity:', error);
                alert('Error adding activity. Please try again.');
            });
        }
        
        // Utility functions
        function generateTripCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
    </script>
</body>
</html>

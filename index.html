<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelMate - Trip Management</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Lottie Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.10.2/lottie.min.js"></script>
    
    <style>
        :root {
            --primary: #4A6FA5;
            --secondary: #6B8E23;
            --accent: #FF6B6B;
            --light: #F8F9FA;
            --dark: #343A40;
            --success: #28A745;
            --warning: #FFC107;
            --info: #17A2B8;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            padding-bottom: 80px;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary), #2C5282);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-link {
            color: white !important;
            font-weight: 500;
        }
        
        .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            border-radius: 20px;
        }
        
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary);
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
        }
        
        .btn-success {
            background-color: var(--secondary);
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
        }
        
        .page {
            display: none;
            padding: 20px 15px;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .trip-card {
            background: linear-gradient(135deg, #4A6FA5, #6B8E23);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        
        .progress {
            height: 10px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .expense-item {
            border-bottom: 1px solid #eee;
            padding: 12px 0;
        }
        
        .expense-item:last-child {
            border-bottom: none;
        }
        
        .checklist-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .checklist-item:last-child {
            border-bottom: none;
        }
        
        .checklist-item.completed {
            text-decoration: line-through;
            color: #6c757d;
        }
        
        .budget-meter {
            height: 20px;
            border-radius: 10px;
            background-color: #e9ecef;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .budget-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s;
        }
        
        .lottie-container {
            width: 100%;
            height: 200px;
            margin: 0 auto;
        }
        
        .stats-card {
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .stats-card i {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px 0;
            z-index: 1000;
        }
        
        .nav-item {
            text-align: center;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .nav-label {
            font-size: 12px;
        }
        
        .add-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .trip-badge {
            background-color: var(--info);
            color: white;
            border-radius: 20px;
            padding: 3px 10px;
            font-size: 12px;
        }
        
        .expense-category {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 15px;
        }
        
        .food { background-color: #FF6B6B; }
        .transport { background-color: #4ECDC4; }
        .accommodation { background-color: #45B7D1; }
        .activities { background-color: #96CEB4; }
        .shopping { background-color: #FFEAA7; color: #333; }
        .other { background-color: #DDA0DD; }
        
        .map-container {
            height: 200px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .distance-result {
            background-color: var(--light);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .dropdown-menu {
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="page active">
        <div class="login-container">
            <div class="lottie-container" id="login-animation"></div>
            <h2 class="mb-4">Welcome to TravelMate</h2>
            <p class="text-muted mb-4">Your ultimate trip management companion</p>
            <button id="google-signin" class="btn btn-primary w-100 mb-3">
                <i class="fab fa-google me-2"></i> Sign in with Google
            </button>
            <button id="anonymous-signin" class="btn btn-outline-secondary w-100">
                <i class="fas fa-user me-2"></i> Continue as Guest
            </button>
        </div>
    </div>

    <!-- App Content (Hidden until authenticated) -->
    <div id="app-content" class="d-none">
        <!-- Top Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand fw-bold" href="#">
                    <i class="fas fa-route me-2"></i>TravelMate
                </a>
                <div class="navbar-nav ms-auto">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <img id="user-avatar" class="user-avatar" src="" alt="User">
                            <span id="user-name">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i> Profile</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="sign-out"><i class="fas fa-sign-out-alt me-2"></i> Sign Out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container mt-4">
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page active">
                <h2 class="mb-4">My Trips</h2>
                
                <!-- Current Trip Card -->
                <div class="trip-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h4 id="current-trip-name">Road Trip to Mountains</h4>
                            <p class="mb-1" id="current-trip-dates">June 15 - June 20, 2023</p>
                            <span class="trip-badge">Active</span>
                        </div>
                        <div class="text-end">
                            <p class="mb-1" id="current-trip-travelers">4 Friends</p>
                            <p class="mb-0">Budget: <span id="current-trip-budget">$1,200</span></p>
                        </div>
                    </div>
                    
                    <div class="progress mt-3">
                        <div id="budget-progress" class="progress-bar bg-warning" role="progressbar" style="width: 65%"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small>Budget Used: <span id="budget-used-percent">65%</span></small>
                        <small>$<span id="budget-used">780</span> / $<span id="budget-total">1,200</span></small>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="row">
                    <div class="col-6">
                        <div class="stats-card bg-primary text-white">
                            <i class="fas fa-road"></i>
                            <h5 id="stats-distance">325 km</h5>
                            <p>Distance</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stats-card bg-success text-white">
                            <i class="fas fa-gas-pump"></i>
                            <h5 id="stats-fuel">28 L</h5>
                            <p>Fuel Used</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stats-card bg-info text-white">
                            <i class="fas fa-dollar-sign"></i>
                            <h5 id="stats-expenses">$245</h5>
                            <p>Expenses</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stats-card bg-warning text-dark">
                            <i class="fas fa-tasks"></i>
                            <h5 id="stats-checklist">8/12</h5>
                            <p>Checklist</p>
                        </div>
                    </div>
                </div>
                
                <!-- Upcoming Trips -->
                <h4 class="mt-4 mb-3">Upcoming Trips</h4>
                <div id="upcoming-trips-list">
                    <!-- Upcoming trips will be loaded here -->
                </div>
            </div>

            <!-- Distance & Mileage Page -->
            <div id="distance-page" class="page">
                <h2 class="mb-4">Distance & Mileage</h2>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-route me-2"></i> Route Calculator
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Starting Point</label>
                            <input type="text" class="form-control" id="start-location" placeholder="Enter starting location" value="New York, NY">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Destination</label>
                            <input type="text" class="form-control" id="end-location" placeholder="Enter destination" value="Boston, MA">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vehicle Mileage (km/L)</label>
                            <input type="number" class="form-control" id="vehicle-mileage" value="12">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fuel Price (per liter)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="fuel-price" value="1.2" step="0.01">
                            </div>
                        </div>
                        <button class="btn btn-primary w-100" id="calculate-route">Calculate Route</button>
                    </div>
                </div>
                
                <div class="distance-result d-none" id="route-result">
                    <h5>Route Summary</h5>
                    <div class="row text-center mt-3">
                        <div class="col-4">
                            <h6>Distance</h6>
                            <h4 class="text-primary" id="result-distance">306 km</h4>
                        </div>
                        <div class="col-4">
                            <h6>Duration</h6>
                            <h4 class="text-primary" id="result-duration">3h 45m</h4>
                        </div>
                        <div class="col-4">
                            <h6>Fuel Cost</h6>
                            <h4 class="text-primary" id="result-fuel-cost">$30.60</h4>
                        </div>
                    </div>
                </div>
                
                <div class="map-container">
                    <!-- Placeholder for map -->
                    <div class="d-flex justify-content-center align-items-center h-100 text-muted">
                        <div class="text-center">
                            <i class="fas fa-map-marked-alt fa-3x mb-3"></i>
                            <p>Interactive Map</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history me-2"></i> Recent Routes
                    </div>
                    <div class="card-body" id="recent-routes">
                        <!-- Recent routes will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Expenses Page -->
            <div id="expenses-page" class="page">
                <h2 class="mb-4">Expenses</h2>
                
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-money-bill-wave me-2"></i> Expense Summary</span>
                        <span class="fw-bold" id="total-expenses">$245.75</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Total Budget</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="trip-budget" value="1200">
                            </div>
                        </div>
                        
                        <div class="budget-meter">
                            <div class="budget-fill bg-warning" id="budget-meter-fill" style="width: 20%"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small id="budget-percent">20% of budget used</small>
                            <small>$<span id="expenses-amount">245</span> / $<span id="budget-amount">1,200</span></small>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-list me-2"></i> Recent Expenses</span>
                        <button class="btn btn-sm btn-primary" id="add-expense-btn">Add Expense</button>
                    </div>
                    <div class="card-body" id="expenses-list">
                        <!-- Expenses will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Checklist Page -->
            <div id="checklist-page" class="page">
                <h2 class="mb-4">Trip Checklist</h2>
                
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-tasks me-2"></i> Packing List</span>
                        <span class="badge bg-primary" id="packing-progress">8/12 items</span>
                    </div>
                    <div class="card-body" id="packing-checklist">
                        <!-- Packing checklist will be loaded here -->
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-car me-2"></i> Vehicle Preparation</span>
                        <button class="btn btn-sm btn-primary" id="add-checklist-item">Add Item</button>
                    </div>
                    <div class="card-body" id="vehicle-checklist">
                        <!-- Vehicle checklist will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Budget Page -->
            <div id="budget-page" class="page">
                <h2 class="mb-4">Budget Tracking</h2>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-pie me-2"></i> Budget Overview
                    </div>
                    <div class="card-body">
                        <div class="lottie-container" id="budget-chart">
                            <!-- Lottie animation will be loaded here -->
                        </div>
                        
                        <div class="row text-center mt-3" id="budget-categories">
                            <!-- Budget categories will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-exchange-alt me-2"></i> Expense Distribution
                    </div>
                    <div class="card-body" id="expense-distribution">
                        <!-- Expense distribution will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="container">
                <div class="row">
                    <div class="col nav-item">
                        <a href="#" class="nav-link active" data-page="dashboard-page">
                            <div class="nav-icon"><i class="fas fa-home"></i></div>
                            <div class="nav-label">Dashboard</div>
                        </a>
                    </div>
                    <div class="col nav-item">
                        <a href="#" class="nav-link" data-page="distance-page">
                            <div class="nav-icon"><i class="fas fa-route"></i></div>
                            <div class="nav-label">Distance</div>
                        </a>
                    </div>
                    <div class="col nav-item">
                        <a href="#" class="nav-link" data-page="expenses-page">
                            <div class="nav-icon"><i class="fas fa-money-bill-wave"></i></div>
                            <div class="nav-label">Expenses</div>
                        </a>
                    </div>
                    <div class="col nav-item">
                        <a href="#" class="nav-link" data-page="checklist-page">
                            <div class="nav-icon"><i class="fas fa-tasks"></i></div>
                            <div class="nav-label">Checklist</div>
                        </a>
                    </div>
                    <div class="col nav-item">
                        <a href="#" class="nav-link" data-page="budget-page">
                            <div class="nav-icon"><i class="fas fa-chart-bar"></i></div>
                            <div class="nav-label">Budget</div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Button -->
        <div class="add-btn">
            <i class="fas fa-plus fa-lg"></i>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>

        <!-- Toast Notifications -->
        <div class="toast align-items-center text-white bg-success border-0" id="success-toast" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="success-message">
                    Operation completed successfully!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>

        <div class="toast align-items-center text-white bg-danger border-0" id="error-toast" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="error-message">
                    An error occurred!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div class="modal fade" id="expenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="expense-form">
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" id="expense-description" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="expense-amount" step="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="expense-category" required>
                                <option value="food">Food & Dining</option>
                                <option value="transport">Transport</option>
                                <option value="accommodation">Accommodation</option>
                                <option value="activities">Activities</option>
                                <option value="shopping">Shopping</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="expense-date" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-expense">Save Expense</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Checklist Item Modal -->
    <div class="modal fade" id="checklistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Checklist Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="checklist-form">
                        <div class="mb-3">
                            <label class="form-label">Item Name</label>
                            <input type="text" class="form-control" id="checklist-item-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="checklist-category" required>
                                <option value="packing">Packing</option>
                                <option value="vehicle">Vehicle</option>
                                <option value="documents">Documents</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-checklist-item">Save Item</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
  apiKey: "AIzaSyBovkc7ohfvTlZUiqDQrQLW2B6aXAE000k",
  authDomain: "travel-mate-5729f.firebaseapp.com",
  projectId: "travel-mate-5729f",
  storageBucket: "travel-mate-5729f.firebasestorage.app",
  messagingSenderId: "164820425577",
  appId: "1:164820425577:web:dd1a93c232555a59f3bbf8",
  measurementId: "G-GETZV3X0ER"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Google Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // App State
        let currentUser = null;
        let currentTrip = null;
        let userTrips = [];
        let userExpenses = [];
        let userChecklist = [];

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const appContent = document.getElementById('app-content');
        const googleSignInBtn = document.getElementById('google-signin');
        const anonymousSignInBtn = document.getElementById('anonymous-signin');
        const signOutBtn = document.getElementById('sign-out');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const loadingIndicator = document.getElementById('loading');
        const successToast = new bootstrap.Toast(document.getElementById('success-toast'));
        const errorToast = new bootstrap.Toast(document.getElementById('error-toast'));

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initAuth();
            initEventListeners();
            initLottieAnimations();
        });

        // Authentication Functions
        function initAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    showApp();
                    loadUserData();
                } else {
                    showLogin();
                }
            });
        }

        function signInWithGoogle() {
            showLoading();
            auth.signInWithPopup(googleProvider)
                .then(result => {
                    hideLoading();
                    showSuccess('Signed in successfully!');
                })
                .catch(error => {
                    hideLoading();
                    showError('Failed to sign in: ' + error.message);
                });
        }

        function signInAnonymously() {
            showLoading();
            auth.signInAnonymously()
                .then(result => {
                    hideLoading();
                    showSuccess('Signed in as guest!');
                })
                .catch(error => {
                    hideLoading();
                    showError('Failed to sign in: ' + error.message);
                });
        }

        function signOut() {
            showLoading();
            auth.signOut()
                .then(() => {
                    hideLoading();
                    showSuccess('Signed out successfully!');
                })
                .catch(error => {
                    hideLoading();
                    showError('Failed to sign out: ' + error.message);
                });
        }

        // UI Functions
        function showLogin() {
            loginPage.classList.add('active');
            appContent.classList.add('d-none');
        }

        function showApp() {
            loginPage.classList.remove('active');
            appContent.classList.remove('d-none');
            
            // Update user info
            if (currentUser.photoURL) {
                userAvatar.src = currentUser.photoURL;
            } else {
                userAvatar.src = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUser.displayName || 'User') + '&background=4A6FA5&color=fff';
            }
            userName.textContent = currentUser.displayName || 'User';
        }

        function showLoading() {
            loadingIndicator.style.display = 'block';
        }

        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        function showSuccess(message) {
            document.getElementById('success-message').textContent = message;
            successToast.show();
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            errorToast.show();
        }

        // Data Management Functions
        function loadUserData() {
            showLoading();
            
            // Load user trips
            db.collection('trips').where('userId', '==', currentUser.uid)
                .get()
                .then(snapshot => {
                    userTrips = [];
                    snapshot.forEach(doc => {
                        userTrips.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Set current trip (for demo, using the first one)
                    if (userTrips.length > 0) {
                        currentTrip = userTrips[0];
                        updateDashboard();
                    } else {
                        // Create a demo trip if none exists
                        createDemoTrip();
                    }
                    
                    // Load expenses
                    return db.collection('expenses').where('tripId', '==', currentTrip.id).get();
                })
                .then(snapshot => {
                    userExpenses = [];
                    snapshot.forEach(doc => {
                        userExpenses.push({ id: doc.id, ...doc.data() });
                    });
                    updateExpensesPage();
                    
                    // Load checklist
                    return db.collection('checklist').where('tripId', '==', currentTrip.id).get();
                })
                .then(snapshot => {
                    userChecklist = [];
                    snapshot.forEach(doc => {
                        userChecklist.push({ id: doc.id, ...doc.data() });
                    });
                    updateChecklistPage();
                    
                    hideLoading();
                })
                .catch(error => {
                    hideLoading();
                    showError('Failed to load data: ' + error.message);
                });
        }

        function createDemoTrip() {
            const demoTrip = {
                userId: currentUser.uid,
                name: 'Road Trip to Mountains',
                startDate: '2023-06-15',
                endDate: '2023-06-20',
                travelers: 4,
                budget: 1200,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('trips').add(demoTrip)
                .then(docRef => {
                    currentTrip = { id: docRef.id, ...demoTrip };
                    userTrips.push(currentTrip);
                    updateDashboard();
                    
                    // Create demo expenses
                    createDemoExpenses(docRef.id);
                    // Create demo checklist
                    createDemoChecklist(docRef.id);
                })
                .catch(error => {
                    showError('Failed to create demo trip: ' + error.message);
                });
        }

        function createDemoExpenses(tripId) {
            const demoExpenses = [
                { description: 'Dinner at Restaurant', amount: 64.50, category: 'food', date: '2023-06-15', tripId },
                { description: 'Fuel', amount: 45.00, category: 'transport', date: '2023-06-15', tripId },
                { description: 'Hotel Stay', amount: 120.00, category: 'accommodation', date: '2023-06-14', tripId },
                { description: 'Park Entrance', amount: 16.25, category: 'activities', date: '2023-06-14', tripId }
            ];
            
            demoExpenses.forEach(expense => {
                db.collection('expenses').add(expense);
            });
        }

        function createDemoChecklist(tripId) {
            const demoChecklist = [
                { name: 'Passport/ID', category: 'documents', completed: true, tripId },
                { name: 'Phone & Charger', category: 'packing', completed: true, tripId },
                { name: 'Wallet with Cash/Cards', category: 'packing', completed: true, tripId },
                { name: 'First Aid Kit', category: 'packing', completed: false, tripId },
                { name: 'Snacks & Water', category: 'packing', completed: true, tripId },
                { name: 'Maps & Directions', category: 'documents', completed: false, tripId },
                { name: 'Clothing', category: 'packing', completed: true, tripId },
                { name: 'Toiletries', category: 'packing', completed: false, tripId },
                { name: 'Check Oil & Fluids', category: 'vehicle', completed: true, tripId },
                { name: 'Inspect Tires', category: 'vehicle', completed: true, tripId },
                { name: 'Check Brakes', category: 'vehicle', completed: false, tripId },
                { name: 'Fill Up Fuel Tank', category: 'vehicle', completed: true, tripId }
            ];
            
            demoChecklist.forEach(item => {
                db.collection('checklist').add(item);
            });
        }

        // Update UI Functions
        function updateDashboard() {
            if (!currentTrip) return;
            
            document.getElementById('current-trip-name').textContent = currentTrip.name;
            document.getElementById('current-trip-dates').textContent = 
                `${formatDate(currentTrip.startDate)} - ${formatDate(currentTrip.endDate)}`;
            document.getElementById('current-trip-travelers').textContent = 
                `${currentTrip.travelers} ${currentTrip.travelers === 1 ? 'Person' : 'People'}`;
            document.getElementById('current-trip-budget').textContent = `$${currentTrip.budget}`;
            
            // Calculate budget usage
            const totalExpenses = userExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const budgetPercent = Math.min(100, (totalExpenses / currentTrip.budget) * 100);
            
            document.getElementById('budget-progress').style.width = `${budgetPercent}%`;
            document.getElementById('budget-used-percent').textContent = `${Math.round(budgetPercent)}%`;
            document.getElementById('budget-used').textContent = totalExpenses.toFixed(2);
            document.getElementById('budget-total').textContent = currentTrip.budget;
            
            // Update stats
            document.getElementById('stats-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
            
            // Calculate completed checklist items
            const completedItems = userChecklist.filter(item => item.completed).length;
            const totalItems = userChecklist.length;
            document.getElementById('stats-checklist').textContent = `${completedItems}/${totalItems}`;
            
            // Update upcoming trips
            updateUpcomingTrips();
        }

        function updateUpcomingTrips() {
            const upcomingTripsList = document.getElementById('upcoming-trips-list');
            upcomingTripsList.innerHTML = '';
            
            // For demo, show some placeholder trips
            const demoUpcomingTrips = [
                { name: 'Beach Vacation', date: '2023-07-10', travelers: 6, budget: 800 },
                { name: 'City Break', date: '2023-08-05', travelers: 2, budget: 400 }
            ];
            
            demoUpcomingTrips.forEach(trip => {
                const tripCard = document.createElement('div');
                tripCard.className = 'card';
                tripCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">${trip.name}</h5>
                            <span class="trip-badge bg-secondary">${formatDate(trip.date)}</span>
                        </div>
                        <p class="card-text">${trip.travelers} ${trip.travelers === 1 ? 'Person' : 'People'}</p>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-users me-1"></i> ${trip.travelers} People</span>
                            <span><i class="fas fa-dollar-sign me-1"></i> $${trip.budget} Budget</span>
                        </div>
                    </div>
                `;
                upcomingTripsList.appendChild(tripCard);
            });
        }

        function updateExpensesPage() {
            if (!currentTrip) return;
            
            // Update budget summary
            const totalExpenses = userExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('expenses-amount').textContent = totalExpenses.toFixed(2);
            document.getElementById('budget-amount').textContent = currentTrip.budget;
            
            const budgetPercent = Math.min(100, (totalExpenses / currentTrip.budget) * 100);
            document.getElementById('budget-meter-fill').style.width = `${budgetPercent}%`;
            document.getElementById('budget-percent').textContent = `${Math.round(budgetPercent)}% of budget used`;
            
            // Update expenses list
            const expensesList = document.getElementById('expenses-list');
            expensesList.innerHTML = '';
            
            if (userExpenses.length === 0) {
                expensesList.innerHTML = '<p class="text-muted text-center">No expenses yet</p>';
                return;
            }
            
            // Sort expenses by date (newest first)
            const sortedExpenses = [...userExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedExpenses.forEach(expense => {
                const expenseItem = document.createElement('div');
                expenseItem.className = 'expense-item d-flex align-items-center';
                
                const categoryClass = getCategoryClass(expense.category);
                const categoryIcon = getCategoryIcon(expense.category);
                
                expenseItem.innerHTML = `
                    <div class="expense-category ${categoryClass}">
                        <i class="${categoryIcon}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${expense.description}</h6>
                        <small class="text-muted">${formatDate(expense.date)}</small>
                    </div>
                    <div class="text-end">
                        <h6 class="mb-1">$${expense.amount.toFixed(2)}</h6>
                        <small class="text-muted">You paid</small>
                    </div>
                `;
                
                expensesList.appendChild(expenseItem);
            });
        }

        function updateChecklistPage() {
            // Group checklist items by category
            const packingItems = userChecklist.filter(item => item.category === 'packing' || item.category === 'documents');
            const vehicleItems = userChecklist.filter(item => item.category === 'vehicle');
            
            // Update packing checklist
            const packingChecklist = document.getElementById('packing-checklist');
            packingChecklist.innerHTML = '';
            
            packingItems.forEach(item => {
                const checklistItem = createChecklistItemElement(item);
                packingChecklist.appendChild(checklistItem);
            });
            
            // Update vehicle checklist
            const vehicleChecklist = document.getElementById('vehicle-checklist');
            vehicleChecklist.innerHTML = '';
            
            vehicleItems.forEach(item => {
                const checklistItem = createChecklistItemElement(item);
                vehicleChecklist.appendChild(checklistItem);
            });
            
            // Update progress
            const completedItems = userChecklist.filter(item => item.completed).length;
            const totalItems = userChecklist.length;
            document.getElementById('packing-progress').textContent = `${completedItems}/${totalItems} items`;
        }

        function createChecklistItemElement(item) {
            const checklistItem = document.createElement('div');
            checklistItem.className = `checklist-item ${item.completed ? 'completed' : ''}`;
            checklistItem.innerHTML = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checklist-${item.id}" ${item.completed ? 'checked' : ''}>
                    <label class="form-check-label" for="checklist-${item.id}">
                        ${item.name}
                    </label>
                </div>
            `;
            
            // Add event listener for checkbox
            const checkbox = checklistItem.querySelector('input');
            checkbox.addEventListener('change', function() {
                updateChecklistItem(item.id, this.checked);
            });
            
            return checklistItem;
        }

        function updateChecklistItem(itemId, completed) {
            db.collection('checklist').doc(itemId).update({
                completed: completed,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Update local data
                const itemIndex = userChecklist.findIndex(item => item.id === itemId);
                if (itemIndex !== -1) {
                    userChecklist[itemIndex].completed = completed;
                }
                
                // Update UI
                updateChecklistPage();
                updateDashboard();
            })
            .catch(error => {
                showError('Failed to update checklist: ' + error.message);
            });
        }

        // Distance Matrix API Integration
        function calculateDistance() {
            const startLocation = document.getElementById('start-location').value;
            const endLocation = document.getElementById('end-location').value;
            const vehicleMileage = parseFloat(document.getElementById('vehicle-mileage').value);
            const fuelPrice = parseFloat(document.getElementById('fuel-price').value);
            
            if (!startLocation || !endLocation) {
                showError('Please enter both start and end locations');
                return;
            }
            
            showLoading();
            
            // In a real implementation, you would call the Distance Matrix API here
            // For demo purposes, we'll use mock data
            setTimeout(() => {
                // Mock API response
                const mockResponse = {
                    distance: { text: '306 km', value: 306000 },
                    duration: { text: '3 hours 45 mins', value: 13500 },
                    status: 'OK'
                };
                
                if (mockResponse.status === 'OK') {
                    const distance = mockResponse.distance.value / 1000; // Convert to km
                    const duration = mockResponse.duration.text;
                    
                    // Calculate fuel cost
                    const fuelRequired = distance / vehicleMileage;
                    const fuelCost = fuelRequired * fuelPrice;
                    
                    // Display results
                    document.getElementById('result-distance').textContent = `${distance} km`;
                    document.getElementById('result-duration').textContent = duration;
                    document.getElementById('result-fuel-cost').textContent = `$${fuelCost.toFixed(2)}`;
                    
                    document.getElementById('route-result').classList.remove('d-none');
                    
                    // Save to recent routes
                    saveRecentRoute(startLocation, endLocation, distance, duration, fuelCost);
                    
                    hideLoading();
                    showSuccess('Route calculated successfully!');
                } else {
                    hideLoading();
                    showError('Failed to calculate route. Please check your locations.');
                }
            }, 1500);
        }

        function saveRecentRoute(start, end, distance, duration, cost) {
            const routeData = {
                start,
                end,
                distance,
                duration,
                cost,
                calculatedAt: new Date().toISOString()
            };
            
            // In a real app, you would save this to Firestore
            // For now, we'll just update the UI
            updateRecentRoutes(routeData);
        }

        function updateRecentRoutes(newRoute) {
            const recentRoutesContainer = document.getElementById('recent-routes');
            
            // Create route element
            const routeElement = document.createElement('div');
            routeElement.className = 'd-flex justify-content-between py-2 border-bottom';
            routeElement.innerHTML = `
                <div>
                    <h6 class="mb-1">${newRoute.start} to ${newRoute.end}</h6>
                    <small class="text-muted">${newRoute.distance} km  ${newRoute.duration}</small>
                </div>
                <div class="text-end">
                    <h6 class="mb-1">$${newRoute.cost.toFixed(2)}</h6>
                    <small class="text-muted">${formatDate(newRoute.calculatedAt, true)}</small>
                </div>
            `;
            
            // Add to the top of the list
            if (recentRoutesContainer.children.length > 0) {
                recentRoutesContainer.insertBefore(routeElement, recentRoutesContainer.firstChild);
            } else {
                recentRoutesContainer.appendChild(routeElement);
            }
            
            // Limit to 5 recent routes
            if (recentRoutesContainer.children.length > 5) {
                recentRoutesContainer.removeChild(recentRoutesContainer.lastChild);
            }
        }

        // Utility Functions
        function formatDate(dateString, includeTime = false) {
            const date = new Date(dateString);
            if (includeTime) {
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function getCategoryClass(category) {
            const classes = {
                'food': 'food',
                'transport': 'transport',
                'accommodation': 'accommodation',
                'activities': 'activities',
                'shopping': 'shopping',
                'other': 'other'
            };
            return classes[category] || 'other';
        }

        function getCategoryIcon(category) {
            const icons = {
                'food': 'fas fa-utensils',
                'transport': 'fas fa-gas-pump',
                'accommodation': 'fas fa-hotel',
                'activities': 'fas fa-ticket-alt',
                'shopping': 'fas fa-shopping-bag',
                'other': 'fas fa-receipt'
            };
            return icons[category] || 'fas fa-receipt';
        }

        // Event Listeners
        function initEventListeners() {
            // Auth events
            googleSignInBtn.addEventListener('click', signInWithGoogle);
            anonymousSignInBtn.addEventListener('click', signInAnonymously);
            signOutBtn.addEventListener('click', signOut);
            
            // Navigation
            document.querySelectorAll('.nav-link[data-page]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all nav links
                    document.querySelectorAll('.nav-link').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    
                    // Add active class to clicked nav link
                    this.classList.add('active');
                    
                    // Hide all pages
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    // Show selected page
                    const pageId = this.getAttribute('data-page');
                    document.getElementById(pageId).classList.add('active');
                });
            });
            
            // Distance calculation
            document.getElementById('calculate-route').addEventListener('click', calculateDistance);
            
            // Expense management
            document.getElementById('add-expense-btn').addEventListener('click', function() {
                // Reset form
                document.getElementById('expense-form').reset();
                document.getElementById('expense-date').valueAsDate = new Date();
                
                // Show modal
                const expenseModal = new bootstrap.Modal(document.getElementById('expenseModal'));
                expenseModal.show();
            });
            
            document.getElementById('save-expense').addEventListener('click', function() {
                const description = document.getElementById('expense-description').value;
                const amount = parseFloat(document.getElementById('expense-amount').value);
                const category = document.getElementById('expense-category').value;
                const date = document.getElementById('expense-date').value;
                
                if (!description || !amount || !category || !date) {
                    showError('Please fill all fields');
                    return;
                }
                
                const expenseData = {
                    description,
                    amount,
                    category,
                    date,
                    tripId: currentTrip.id,
                    userId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                showLoading();
                
                db.collection('expenses').add(expenseData)
                    .then(docRef => {
                        // Add to local data
                        userExpenses.push({ id: docRef.id, ...expenseData });
                        
                        // Update UI
                        updateExpensesPage();
                        updateDashboard();
                        
                        // Hide modal
                        bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
                        
                        hideLoading();
                        showSuccess('Expense added successfully!');
                    })
                    .catch(error => {
                        hideLoading();
                        showError('Failed to add expense: ' + error.message);
                    });
            });
            
            // Checklist management
            document.getElementById('add-checklist-item').addEventListener('click', function() {
                // Reset form
                document.getElementById('checklist-form').reset();
                
                // Show modal
                const checklistModal = new bootstrap.Modal(document.getElementById('checklistModal'));
                checklistModal.show();
            });
            
            document.getElementById('save-checklist-item').addEventListener('click', function() {
                const name = document.getElementById('checklist-item-name').value;
                const category = document.getElementById('checklist-category').value;
                
                if (!name || !category) {
                    showError('Please fill all fields');
                    return;
                }
                
                const checklistData = {
                    name,
                    category,
                    completed: false,
                    tripId: currentTrip.id,
                    userId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                showLoading();
                
                db.collection('checklist').add(checklistData)
                    .then(docRef => {
                        // Add to local data
                        userChecklist.push({ id: docRef.id, ...checklistData });
                        
                        // Update UI
                        updateChecklistPage();
                        updateDashboard();
                        
                        // Hide modal
                        bootstrap.Modal.getInstance(document.getElementById('checklistModal')).hide();
                        
                        hideLoading();
                        showSuccess('Checklist item added successfully!');
                    })
                    .catch(error => {
                        hideLoading();
                        showError('Failed to add checklist item: ' + error.message);
                    });
            });
            
            // Add button functionality
            document.querySelector('.add-btn').addEventListener('click', function() {
                // Determine which page is active
                const activePage = document.querySelector('.page.active').id;
                
                switch(activePage) {
                    case 'dashboard-page':
                        // In a real app, this would open a "Create Trip" modal
                        showSuccess('Create new trip feature would open here');
                        break;
                    case 'distance-page':
                        // Focus on the calculate button
                        document.getElementById('calculate-route').scrollIntoView({ behavior: 'smooth' });
                        break;
                    case 'expenses-page':
                        document.getElementById('add-expense-btn').click();
                        break;
                    case 'checklist-page':
                        document.getElementById('add-checklist-item').click();
                        break;
                    case 'budget-page':
                        // In a real app, this would open a "Set Budget" modal
                        showSuccess('Set budget feature would open here');
                        break;
                }
            });
        }

        function initLottieAnimations() {
            // Login animation
            lottie.loadAnimation({
                container: document.getElementById('login-animation'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: 'https://assets5.lottiefiles.com/packages/lf20_kdxn8dys.json' // Travel animation
            });
            
            // Budget chart animation
            lottie.loadAnimation({
                container: document.getElementById('budget-chart'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: 'https://assets5.lottiefiles.com/packages/lf20_myejiggj.json' // Chart animation
            });
        }
    </script>
</body>
</html>
